name: Auto-Sync Dev ‚Üî Main

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ‚öôÔ∏è Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # When MAIN is updated ‚Üí sync to DEV
      - name: üîÑ Sync Main ‚Üí Dev
        if: github.ref == 'refs/heads/main'
        run: |
          git fetch origin
          git checkout dev || git checkout -b dev
          if git merge origin/main --no-edit 2>/dev/null; then
            echo "‚úÖ Successfully merged main into dev"
            git push origin dev
          else
            echo "‚ö†Ô∏è Merge conflict detected - creating alert PR"
            git merge --abort
          fi

      # When DEV is updated ‚Üí create PR to MAIN
      - name: üìù Create PR: Dev ‚Üí Main
        if: github.ref == 'refs/heads/dev'
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: dev
          destination_branch: main
          pr_title: "üîÑ Auto-Sync: Dev ‚Üí Main"
          pr_body: |
            ## Automated Pull Request
            
            This PR automatically syncs changes from **dev** branch to **main** branch.
            
            ### Checklist
            - [ ] Code review complete
            - [ ] Tests passing
            - [ ] No conflicts
            
            ---
            *Generated by GitHub Actions*
          pr_label: "auto-sync"

      # Alert on sync failure
      - name: ‚ö†Ô∏è Alert on Sync Failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: main
          destination_branch: dev
          pr_title: "üö® MERGE CONFLICT: Dev ‚Üê Main [MANUAL ACTION REQUIRED]"
          pr_body: |
            # ‚ö†Ô∏è Merge Conflict Detected
            
            Automatic sync from **main** to **dev** failed due to conflicts.
            
            ## Fix it:
            ```
            git checkout dev
            git pull origin main
            # Resolve conflicts, then:
            git add .
            git commit -m "Resolved conflicts"
            git push origin dev
            ```
            
            *Priority: HIGH*
          pr_label: "conflict,urgent"
