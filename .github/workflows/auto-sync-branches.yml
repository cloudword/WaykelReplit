name: Auto-Sync Dev ‚Üî Main

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ‚öôÔ∏è Configure Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # TRIGGER 1: When someone merges to MAIN
      # Action: Automatically sync MAIN ‚Üí DEV
      - name: üîÑ Sync Main to Dev
        if: github.ref == 'refs/heads/main'
        run: |
          git fetch origin main dev
          git checkout dev
          
          # Attempt to merge main into dev
          if git merge origin/main --no-edit; then
            echo "‚úÖ Successfully merged main into dev"
            git push origin dev
          else
            echo "‚ö†Ô∏è Merge conflict detected"
            git merge --abort
            exit 1
          fi
        continue-on-error: true

      # TRIGGER 2: When you push to DEV
      # Action: Create automatic PR for dev ‚Üí main
      - name: üìù Create PR: Dev ‚Üí Main
        if: github.ref == 'refs/heads/dev'
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: dev
          destination_branch: main
          pr_title: "üîÑ Auto-Sync: Dev ‚Üí Main"
          pr_body: |
            ## Automated Pull Request
            
            This PR automatically syncs changes from **dev** branch to **main** branch.
            
            ### Checklist
            - [ ] Code review complete
            - [ ] Tests passing
            - [ ] No conflicts
            - [ ] Ready to merge
            
            ---
            *Generated by GitHub Actions*
          pr_label: "auto-sync,dev-to-main"

      # TRIGGER 3: If sync fails, create alert PR
      - name: ‚ö†Ô∏è Alert on Sync Failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: main
          destination_branch: dev
          pr_title: "üö® MERGE CONFLICT: Dev ‚Üê Main [MANUAL ACTION REQUIRED]"
          pr_body: |
            # ‚ö†Ô∏è Merge Conflict Detected
            
            Automatic sync from **main** to **dev** failed due to conflicts.
            
            ## What to do:
            
            ### Option 1: Resolve Locally (Recommended)
            ```
            git fetch origin
            git checkout dev
            git pull origin main
            
            # Open conflicted files and resolve them
            # Then:
            git add .
            git commit -m "Resolved merge conflicts between main and dev"
            git push origin dev
            ```
            
            ### Option 2: Use GitHub's Web Editor
            - Click "Resolve conflicts" on this PR
            - Choose which changes to keep
            - Mark as resolved
            - Commit changes
            
            ---
            *Priority: HIGH - This blocks automatic syncing*
          pr_label: "conflict,urgent,manual-review"
