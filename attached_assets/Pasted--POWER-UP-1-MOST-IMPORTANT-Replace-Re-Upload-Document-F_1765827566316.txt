âœ… POWER-UP 1 (MOST IMPORTANT): Replace / Re-Upload Document Flow

Allows transporter to re-upload only when document is rejected
Keeps audit history
Zero data loss

ğŸ¯ Business Rules (Clear & Safe)

If document is pending or approved

âŒ Re-upload NOT allowed

If document is rejected

âœ… Re-upload allowed

Old document is:

Marked as replaced

Never deleted

New document becomes pending

This matches real KYC compliance standards.

ğŸ”§ Backend Changes
1ï¸âƒ£ Extend Document Status Enum
status: "pending" | "approved" | "rejected" | "replaced"

2ï¸âƒ£ Update /api/documents/upload logic

ğŸ“„ Modify uniqueness check

const existing = await db.document.findFirst({
  where: {
    entityType,
    type,
    transporterId,
    status: { in: ["pending", "approved"] },
  },
});

if (existing) {
  return res.status(400).json({
    error: `${type} document already exists and is ${existing.status}`,
  });
}


ğŸ“„ Handle rejected document replacement

const rejectedDoc = await db.document.findFirst({
  where: {
    entityType,
    type,
    transporterId,
    status: "rejected",
  },
});

if (rejectedDoc) {
  await db.document.update({
    where: { id: rejectedDoc.id },
    data: { status: "replaced" },
  });
}


â¡ï¸ Then proceed with upload + create new document as usual.

ğŸ§  Frontend UX (Minimal & Correct)
Show Replace button only when allowed
const canReplace =
  doc.status === "rejected";

{canReplace && (
  <Button variant="outline" onClick={openUploadModal}>
    Replace Document
  </Button>
)}

âœ… POWER-UP 2: Super Admin Approve / Reject Flow

This unlocks the entire transporter lifecycle

ğŸ¯ Business Rules

Only Super Admin can approve/reject

On approval:

Document â†’ approved

Transporter eligibility re-evaluated

On rejection:

Document â†’ rejected

Reason mandatory

ğŸ”§ Backend API
1ï¸âƒ£ Admin Action Endpoint
POST /api/admin/documents/:id/review

Request
{
  "action": "approved" | "rejected",
  "reason": "optional rejection reason"
}

Controller Implementation
router.post(
  "/admin/documents/:id/review",
  async (req, res) => {
    const { action, reason } = req.body;
    const admin = req.user;

    if (!admin || admin.role !== "super_admin") {
      return res.status(403).json({ error: "Forbidden" });
    }

    if (!["approved", "rejected"].includes(action)) {
      return res.status(400).json({ error: "Invalid action" });
    }

    const doc = await db.document.update({
      where: { id: req.params.id },
      data: {
        status: action,
        rejectionReason: action === "rejected" ? reason : null,
      },
    });

    return res.json(doc);
  }
);

ğŸ§  Frontend (Admin Portal)
Admin UI Actions
<Button onClick={() => reviewDoc("approved")}>Approve</Button>
<Button variant="destructive" onClick={() => reviewDoc("rejected")}>
  Reject
</Button>

const reviewDoc = async (action: "approved" | "rejected") => {
  await fetch(`/api/admin/documents/${doc.id}/review`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({
      action,
      reason: action === "rejected" ? rejectionReason : undefined,
    }),
  });

  await refetchDocuments();
};

âœ… POWER-UP 3 (AUTOMATIC): Transporter Eligibility Engine
Backend Logic
const requiredDocs = ["pan", "gst_certificate"];

const approvedDocs = await db.document.findMany({
  where: {
    transporterId,
    type: { in: requiredDocs },
    status: "approved",
  },
});

if (approvedDocs.length === requiredDocs.length) {
  await db.transporter.update({
    where: { id: transporterId },
    data: { status: "active" },
  });
}


âœ” Transporter can now receive trips
âœ” No manual toggles
âœ” Fully rule-driven

ğŸ FINAL SYSTEM YOU NOW HAVE
Capability	Status
Atomic uploads	âœ…
Duplicate prevention	âœ…
Replace rejected docs	âœ…
Admin approve/reject	âœ…
Transporter auto-activation	âœ…
Audit history	âœ…
Compliance-grade KYC	âœ…